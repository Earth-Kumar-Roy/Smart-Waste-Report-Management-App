<!DOCTYPE html>
<html>
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Raise Waste Issue | Citizen Portal</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-slate-50 font-sans min-h-screen p-4 flex items-center justify-center bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-emerald-100 via-slate-50 to-blue-50">

	<div class="max-w-xl w-full bg-white rounded-3xl shadow-2xl border border-slate-100 overflow-hidden transform transition-all duration-500">

		<div class="bg-emerald-700 p-6 text-center text-white relative">
			<div class="absolute top-4 right-4 opacity-20 text-4xl">
				<i class="fas fa-bullhorn"></i>
			</div>
			<h2 class="text-2xl font-black tracking-tight mb-1 uppercase text-white">Raise Waste Issue</h2>
			<p class="text-emerald-100 text-xs font-medium opacity-90 uppercase tracking-widest">Citizen Reporting Portal | Kolkata</p>
		</div>

		<div class="flex border-b border-slate-100">
			<button onclick="loadPage('Index')" class="flex-1 py-3 text-xs font-bold text-slate-500 hover:bg-slate-50 hover:text-emerald-700 transition flex items-center justify-center gap-2 border-r border-slate-100">
                <i class="fas fa-home"></i> Home
            </button>
			<button onclick="loadPage('CheckStatus')" class="flex-1 py-3 text-xs font-bold text-slate-500 hover:bg-slate-50 hover:text-emerald-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-search-location"></i> Check Status
            </button>
		</div>

		<div class="p-6 md:p-8 space-y-5 text-gray-800">
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div class="relative">
					<span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 text-xs"><i class="fas fa-user"></i></span>
					<input type="text" id="name" placeholder="Full Name" class="w-full pl-9 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 transition-all text-sm">
                </div>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 text-xs"><i class="fas fa-phone"></i></span>
                    <input type="tel" id="mobile" placeholder="Mobile Number" class="w-full pl-9 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 transition-all text-sm">
                </div>
			</div>

            <div class="relative">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 text-xs"><i class="fas fa-envelope"></i></span>
                <input type="email" id="email" placeholder="Email Address" class="w-full pl-9 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 transition-all text-sm">
            </div>

            <div id="locationWrapper" class="bg-emerald-50/50 p-4 rounded-2xl border border-emerald-100 space-y-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-emerald-800 font-bold text-xs uppercase tracking-tighter">
                        <i class="fas fa-map-marker-alt"></i> <span id="locLabel">Waiting for Location Permission...</span>
                    </div>
                    <div id="locSpinner" class="animate-spin text-emerald-600 text-xs"><i class="fas fa-spinner"></i></div>
                </div>

                <div id="gpsInputs" class="grid grid-cols-2 gap-3">
                    <input type="text" id="latitude" placeholder="Latitude" readonly class="w-full px-4 py-2 bg-white border border-emerald-200 rounded-lg text-xs text-slate-500 cursor-not-allowed">
                    <input type="text" id="longitude" placeholder="Longitude" readonly class="w-full px-4 py-2 bg-white border border-emerald-200 rounded-lg text-xs text-slate-500 cursor-not-allowed">
                </div>

                <div id="manualInputs" class="hidden space-y-2">
                    <input type="text" id="address1" placeholder="Address Line 1 " class="w-full px-4 py-2 bg-white border border-orange-200 rounded-lg text-xs outline-none focus:ring-1 focus:ring-orange-400">
                    <input type="text" id="address2" placeholder="Address Line 2 " class="w-full px-4 py-2 bg-white border border-orange-200 rounded-lg text-xs outline-none focus:ring-1 focus:ring-orange-400">
                    <p class="text-[9px] text-orange-600 font-bold italic">GPS Failed. Manually fill location (precisely).</p>
                </div>

                <select id="region" class="w-full px-4 py-3 bg-white border border-emerald-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 text-sm font-medium text-slate-700">
                    <option value="">Select Local Region</option>
                    <option>Esplanade</option><option>Sealdah</option><option>Howrah</option>
                    <option>Bidhannagar</option><option>Baranagar</option><option>Dumdum</option>
                    <option>Tollygunge</option><option>Khidirpur</option><option>Newtown</option>
                    <option>Gobra</option>
                </select>
            </div>

            <div class="space-y-1">
                <textarea id="description" maxlength="300" placeholder="Describe the issue..." class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 transition-all text-sm h-28 resize-none shadow-inner"></textarea>
                <div class="text-[10px] font-black text-slate-400 text-right px-2 uppercase tracking-widest">
                    <span id="charUsed">0</span> / 300 Characters
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <label class="relative flex flex-col items-center justify-center w-full h-32 border-2 border-emerald-200 border-dashed rounded-2xl bg-emerald-50/30 cursor-pointer hover:bg-emerald-50 transition">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6 text-gray-800">
                        <i class="fas fa-camera text-emerald-600 text-2xl mb-2"></i>
                        <p class="text-xs text-emerald-700 font-black uppercase">Upload Site Photo</p>
                    </div>
                    <input type="file" id="image" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                </label>
                <div id="fileName" class="text-center text-[10px] text-slate-400 font-bold italic">No proof selected</div>
            </div>

            <button onclick="submitIssue()" class="submit-btn w-full py-4 bg-emerald-700 hover:bg-emerald-800 text-white font-black rounded-2xl shadow-xl shadow-emerald-700/20 active:scale-95 transition-all uppercase tracking-widest text-sm">
                Submit Report
            </button>

            <div id="status" class="text-center text-xs font-black min-h-[16px] uppercase tracking-tighter text-emerald-700"></div>
		</div>

		<div class="bg-slate-50 p-4 border-t border-slate-100">
			<footer class="text-center text-[9px] text-slate-400 font-medium uppercase tracking-widest">
				Â© 2026 Code Alchemists | Smart Waste Report Management App
			</footer>
		</div>
	</div>

	<script>
(function () {
    "use strict";

    let locationFetched = false;
    let submitInterval = null;

    // FORCED LOCATION REQUEST AT START
    // This executes immediately as the script is parsed to trigger the prompt
    initLocationRequest();

    window.onload = function () {
        // UI Listeners
        const fileInput = document.getElementById("image");
        fileInput.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                if (file.size > 3 * 1024 * 1024) {
                    alert("File size exceeds 3MB.");
                    this.value = "";
                    document.getElementById("fileName").textContent = "No file chosen";
                    return;
                }
                document.getElementById("fileName").textContent = "ATTACHED: " + file.name;
                document.getElementById("fileName").classList.add("text-emerald-600");
            }
        });

        document.getElementById("description").addEventListener("input", function () {
            document.getElementById("charUsed").innerText = this.value.length;
        });
    };

    function initLocationRequest() {
        if (!navigator.geolocation) {
            switchToManual();
            return;
        }

        // Set a 20-second timeout for manual switch
        const locTimer = setTimeout(() => {
            if (!locationFetched) switchToManual();
        }, 20000);

        navigator.geolocation.getCurrentPosition(
            pos => {
                locationFetched = true;
                clearTimeout(locTimer);
                document.getElementById("latitude").value = pos.coords.latitude;
                document.getElementById("longitude").value = pos.coords.longitude;
                document.getElementById("locSpinner").classList.add("hidden");
                document.getElementById("locLabel").innerText = "Location Captured Successfully";
            },
            err => {
                locationFetched = false;
                clearTimeout(locTimer);
                console.warn("Location error:", err.message);
                switchToManual();
            },
            { 
                enableHighAccuracy: true, 
                timeout: 15000, 
                maximumAge: 0 
            }
        );
    }

    function switchToManual() {
        const gpsInputs = document.getElementById("gpsInputs");
        const manualInputs = document.getElementById("manualInputs");
        const locLabel = document.getElementById("locLabel");
        const locSpinner = document.getElementById("locSpinner");
        const wrapper = document.getElementById("locationWrapper");

        if (gpsInputs) gpsInputs.classList.add("hidden");
        if (manualInputs) manualInputs.classList.remove("hidden");
        if (locSpinner) locSpinner.classList.add("hidden");
        if (locLabel) locLabel.innerText = "Manual Location Required";
        
        if (wrapper) {
            wrapper.classList.replace("bg-emerald-50/50", "bg-orange-50/50");
            wrapper.classList.replace("border-emerald-100", "border-orange-100");
        }
    }

    function loadPage(page) {
        google.script.run.withSuccessHandler(html => {
            document.open();
            document.write(html);
            document.close();
        }).loadPage(page);
    }

    function submitIssue() {
        const submitBtn = document.querySelector(".submit-btn");
        const statusEl = document.getElementById("status");

        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const mobile = document.getElementById("mobile").value.trim();
        const region = document.getElementById("region").value;
        const description = document.getElementById("description").value.trim();
        const imageFile = document.getElementById("image").files[0];

        let latVal, longVal;

        if (locationFetched) {
            latVal = document.getElementById("latitude").value;
            longVal = document.getElementById("longitude").value;
        } else {
            latVal = document.getElementById("address1").value.trim();
            longVal = document.getElementById("address2").value.trim();
        }

        if (!name || !email || !mobile || !region || !latVal || !longVal || !description || !imageFile) {
            statusEl.innerText = "All fields and location are mandatory";
            statusEl.style.color = "#e11d48";
            return;
        }

        submitBtn.disabled = true;
        submitBtn.classList.replace("bg-emerald-700", "bg-slate-300");

        let dots = 0;
        statusEl.style.color = "#047857";
        submitInterval = setInterval(() => {
            dots = (dots + 1) % 4;
            statusEl.innerText = "Submitting Issue" + ".".repeat(dots);
        }, 500);

        const reader = new FileReader();
        reader.onload = function (e) {
            const base64Image = e.target.result.split(",")[1];
            google.script.run
                .withSuccessHandler(res => {
                    clearInterval(submitInterval);
                    statusEl.innerText = res.msg;
                    submitBtn.disabled = false;
                    submitBtn.classList.replace("bg-slate-300", "bg-emerald-700");
                })
                .withFailureHandler(err => {
                    clearInterval(submitInterval);
                    statusEl.innerText = "Error: " + err.message;
                    submitBtn.disabled = false;
                    submitBtn.classList.replace("bg-slate-300", "bg-emerald-700");
                })
                .raiseIssue({
                    name, email, mobile, region,
                    latitude: latVal,
                    longitude: longVal,
                    description,
                    image: base64Image,
                    imageName: imageFile.name
                });
        };
        reader.readAsDataURL(imageFile);
    }

    window.loadPage = loadPage;
    window.submitIssue = submitIssue;

})();
	</script>
</body>
</html>